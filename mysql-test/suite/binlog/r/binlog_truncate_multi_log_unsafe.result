SET GLOBAL max_binlog_size= 4096;
call mtr.add_suppression("Table '.*tm' is marked as crashed and should be repaired");
call mtr.add_suppression("Got an error from unknown thread");
call mtr.add_suppression("Checking table:   '.*tm'");
call mtr.add_suppression("Recovering table: '.*tm'");
call mtr.add_suppression("tc-heuristic-recover cannot trim the binary log to");
call mtr.add_suppression("Can't init tc log");
call mtr.add_suppression("Aborting");
call mtr.add_suppression("Found 1 prepared transactions");
call mtr.add_suppression("mysqld: Table.*tm.*is marked as crashed");
call mtr.add_suppression("Checking table.*tm");
RESET MASTER;
CREATE TABLE ti (a INT PRIMARY KEY, b MEDIUMTEXT) ENGINE=Innodb;
CREATE TABLE tm (f INT) ENGINE=MYISAM;
connect master1,localhost,root,,;
connect master2,localhost,root,,;
connection master1;
SET DEBUG_SYNC= "commit_before_get_LOCK_commit_ordered SIGNAL con1_ready WAIT_FOR con1_go";
INSERT INTO ti VALUES (2, REPEAT("x", 4100));
connection master2;
SET DEBUG_SYNC= "now WAIT_FOR con1_ready";
INSERT INTO tm VALUES (30);
connection default;
# Kill the server
# BINLOG TRUNCATE recovery restart
# ROLLLBACK heuristic recovery restart
# NORMAL restart
connection default;
FOUND # /tc-heuristic-recover cannot trim the binary log/ in mysqld.1.err
SELECT COUNT(*) = 0 as 'True' FROM ti;
True
1
SELECT COUNT(*) <= 1 FROM tm;
COUNT(*) <= 1
1
SELECT @@GLOBAL.gtid_current_pos;
@@GLOBAL.gtid_current_pos
0-1-4
# Cleanup
SET @@global.max_binlog_size = VALUE_AT_START;
DROP TABLE ti, tm;
End of test
